pipeline {
  agent any
 
  environment {
    AWS_DEFAULT_REGION = 'ap-south-1'   // plain env var OK here
  }
 
  parameters {
    booleanParam(name: 'APPLY', defaultValue: true, description: 'Run apply?')
  }
 
  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }
 
    stage('Init & Plan') {
      steps {
        // withCredentials is a step â€” must be inside steps { }
        withCredentials([usernamePassword(
            credentialsId: 'aws-creds', 
            usernameVariable: 'AWS_ACCESS_KEY_ID', 
            passwordVariable: 'AWS_SECRET_ACCESS_KEY')]) {
 
          sh '''
            echo "Using AWS ID: $AWS_ACCESS_KEY_ID"
            terraform init -input=false -reconfigure
            terraform validate
            terraform plan -out=tfplan
          '''
        }
      }
    }
 
    stage('Apply') {
      when { expression { return params.APPLY } }
      steps {
        input 'Approve apply?'
        withCredentials([usernamePassword(
            credentialsId: 'aws-creds', 
            usernameVariable: 'AWS_ACCESS_KEY_ID', 
            passwordVariable: 'AWS_SECRET_ACCESS_KEY')]) {
 
          sh 'terraform apply -auto-approve tfplan'
        }
      }
    }
  }
 
  post {
    always { cleanWs() }
  }
}
 